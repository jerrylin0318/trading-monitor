<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1117">
    <title>Trading Monitor</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="stylesheet" href="/static/style.css?v=70.3">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>🔐 登入</h2>
            <form id="login-form" onsubmit="return handleLogin(event)">
                <div class="login-field">
                    <label for="login-username">帳號</label>
                    <input type="text" id="login-username" autocomplete="username" required>
                </div>
                <div class="login-field">
                    <label for="login-password">密碼</label>
                    <input type="password" id="login-password" autocomplete="current-password" required>
                </div>
                <div class="login-options">
                    <label><input type="checkbox" id="login-remember-user"> 記住帳號</label>
                    <label><input type="checkbox" id="login-remember-pass"> 記住密碼</label>
                    <label><input type="checkbox" id="login-auto"> 自動登入</label>
                </div>
                <div id="login-error" class="login-error"></div>
                <button type="submit" class="btn btn-success login-btn">登入</button>
            </form>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>📊 Trading Monitor</h1>
        <div class="header-right">
            <div class="controls">
                <span id="ib-status">
                    <span class="status-dot disconnected" id="ib-dot"></span>
                    <span id="ib-label" style="font-size:13px;color:var(--text-secondary)">IB 未連線</span>
                </span>
                <button class="btn btn-sm" id="btn-connect" onclick="toggleConnect()">連線</button>
                <span style="color:var(--border)">|</span>
                <span class="status-dot" id="monitor-dot"></span>
                <span id="monitor-label" style="font-size:13px;color:var(--text-secondary)">未啟動</span>
                <button class="btn btn-sm btn-success" id="btn-monitor" onclick="toggleMonitor()">啟動監控</button>
                <span style="color:var(--border)">|</span>
                <button class="btn btn-sm" id="btn-demo" onclick="toggleDemoMode()" title="Demo模式">🎮</button>
                <button class="btn btn-sm" onclick="openSettings()" title="設定">⚙️</button>
                <button class="btn btn-sm" onclick="logout()" title="登出">🚪</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Account Info (Collapsible) -->
        <div class="account-bar" onclick="toggleAccountDetails()">
            <span class="account-bar-label">💰 淨值</span>
            <span class="account-bar-value" id="acc-equity">--</span>
            <span class="account-bar-pnl" id="acc-pnl-badge"></span>
            <span class="account-bar-toggle" id="acc-toggle">▼</span>
        </div>
        <div class="account-details" id="account-details" style="display:none;">
            <div class="account-grid" id="account-grid">
                <div class="account-item">
                    <div class="label">可用資金</div>
                    <div class="value" id="acc-available">--</div>
                </div>
                <div class="account-item">
                    <div class="label">購買力</div>
                    <div class="value" id="acc-buying-power">--</div>
                </div>
                <div class="account-item">
                    <div class="label">未實現盈虧</div>
                    <div class="value" id="acc-unrealized-pnl">--</div>
                </div>
                <div class="account-item">
                    <div class="label">已實現盈虧</div>
                    <div class="value" id="acc-realized-pnl">--</div>
                </div>
            </div>
        </div>

        <!-- Unified Tabbed Card -->
        <div class="card tabbed-card">
            <div class="tab-header">
                <button class="tab-btn active" data-tab="watch" onclick="switchTab('watch')">👁️ 觀察</button>
                <button class="tab-btn" data-tab="positions" onclick="switchTab('positions')">📋 持倉</button>
                <button class="tab-btn" data-tab="orders" onclick="switchTab('orders')">📝 掛單</button>
                <button class="tab-btn" data-tab="signals" onclick="switchTab('signals')">🔔 信號</button>
                <button class="tab-btn" data-tab="logs" onclick="switchTab('logs')">📜 日誌</button>
            </div>
            <div class="tab-content">
                <!-- Watch Tab -->
                <div class="tab-pane active" id="tab-watch">
                    <div class="tab-pane-header">
                        <button class="btn btn-sm btn-primary" onclick="showAddWatch()">+ 新增</button>
                    </div>
                    <!-- Favorites bar -->
                    <div id="favorites-bar" style="display:none; margin-bottom:12px;">
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;" id="fav-chips"></div>
                    </div>
                    <!-- Add form (hidden by default) -->
                    <div id="add-watch-form" style="display:none; margin-bottom:16px;">
                        <!-- Row 1: 標的 + 類型 + 策略方向 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>標的代碼</label>
                                <input type="text" id="w-symbol" placeholder="SPY, MNQ...">
                            </div>
                            <div class="form-group">
                                <label>類型</label>
                                <select id="w-sectype">
                                    <option value="STK">股票 (STK)</option>
                                    <option value="FUT">期貨 (FUT)</option>
                                    <option value="IND">指數 (IND)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>方向</label>
                                <select id="w-direction">
                                    <option value="LONG">📈 做多</option>
                                    <option value="SHORT">📉 做空</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>策略</label>
                                <select id="w-strategy-type" onchange="updateStrategyFields()">
                                    <option value="MA">MA 均線</option>
                                    <option value="BB">布林帶</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>週期</label>
                                <select id="w-timeframe">
                                    <option value="H">小時線</option>
                                    <option value="D" selected>日線</option>
                                    <option value="W">週線</option>
                                    <option value="M">月線</option>
                                </select>
                            </div>
                        </div>
                        <!-- Row 2: 交易所 + 合約月份 + 幣別 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>交易所</label>
                                <input type="text" id="w-exchange" value="SMART">
                            </div>
                            <div class="form-group" id="w-contract-group" style="display:none;">
                                <label>合約月份</label>
                                <select id="w-contract"></select>
                            </div>
                            <div class="form-group">
                                <label>幣別</label>
                                <input type="text" id="w-currency" value="USD">
                            </div>
                        </div>
                        <!-- Row 3: MA + N點 + 按鈕 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>MA 週期</label>
                                <input type="number" id="w-ma-period" value="21" min="2">
                            </div>
                            <div class="form-group" id="w-n-points-group">
                                <label>N 點</label>
                                <input type="number" id="w-n-points" value="5" step="0.1" min="0">
                            </div>
                            <div class="form-group" id="w-bb-std-group" style="display:none;">
                                <label>標準差倍數</label>
                                <input type="number" id="w-bb-std-dev" value="2" step="0.1" min="0.5" max="4">
                            </div>
                            <div class="form-group" id="w-confirm-ma-group" style="flex:0;">
                                <label style="display:flex;align-items:center;gap:4px;">
                                    <input type="checkbox" id="w-confirm-ma-enabled"> 確認MA
                                </label>
                                <input type="number" id="w-confirm-ma-period" value="55" min="2" style="width:60px;" placeholder="週期">
                            </div>
                        </div>
                        <!-- Row 4: 交易配置 (可折疊) -->
                        <details class="trading-config-section" open>
                            <summary>🤖 自動交易配置</summary>
                            <div class="form-row" style="margin-top:8px;">
                                <div class="form-group" style="flex:0;">
                                    <label style="display:flex;align-items:center;gap:4px;">
                                        <input type="checkbox" id="w-auto-trade" checked> 啟用自動下單
                                    </label>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>交易標的</label>
                                    <div class="trading-targets">
                                        <label><input type="checkbox" id="w-t-stk"> 期貨本體</label>
                                        <input type="number" id="w-t-stk-qty" value="1" min="1" step="1" style="width:50px;" placeholder="口">
                                    </div>
                                    <div class="trading-targets" style="margin-top:4px;">
                                        <span style="font-size:11px;color:var(--text-secondary);">Call:</span>
                                        <label><input type="checkbox" id="w-t-call-0"> ATM</label>
                                        <label><input type="checkbox" id="w-t-call-1" checked> OTM1</label>
                                        <label><input type="checkbox" id="w-t-call-2"> OTM2</label>
                                        <label><input type="checkbox" id="w-t-call-3"> OTM3</label>
                                        <label><input type="checkbox" id="w-t-call-4"> OTM4</label>
                                    </div>
                                    <div class="trading-targets" style="margin-top:4px;">
                                        <span style="font-size:11px;color:var(--text-secondary);">Put:</span>
                                        <label><input type="checkbox" id="w-t-put-0"> ATM</label>
                                        <label><input type="checkbox" id="w-t-put-1" checked> OTM1</label>
                                        <label><input type="checkbox" id="w-t-put-2"> OTM2</label>
                                        <label><input type="checkbox" id="w-t-put-3"> OTM3</label>
                                        <label><input type="checkbox" id="w-t-put-4"> OTM4</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Options 金額 (USD)</label>
                                    <input type="number" id="w-t-amount" value="5000" min="100" step="100">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>出場策略</label>
                                    <div class="exit-options">
                                        <label><input type="checkbox" id="w-exit-profit" checked> 限價止盈</label>
                                        <select id="w-exit-profit-dir" style="width:45px;">
                                            <option value="+">+</option>
                                            <option value="-">−</option>
                                        </select>
                                        <input type="number" id="w-exit-profit-pts" value="50" min="1" step="1" style="width:50px;">
                                        <select id="w-exit-profit-unit" style="width:50px;">
                                            <option value="pct">%</option>
                                            <option value="pts">點</option>
                                        </select>
                                    </div>
                                    <div class="exit-options" style="margin-top:4px;">
                                        <label><input type="checkbox" id="w-exit-time"> 時間出場</label>
                                        <input type="time" id="w-exit-time-val" value="15:30" style="width:90px;">
                                    </div>
                                    <div class="exit-options" style="margin-top:4px;">
                                        <label><input type="checkbox" id="w-exit-loop" checked> 循環交易</label>
                                    </div>
                                </div>
                            </div>
                        </details>
                        <!-- Row 5: 按鈕 -->
                        <div class="form-row" style="margin-top:12px;">
                            <div class="form-group" style="flex:0;">
                                <div style="display:flex;gap:6px;">
                                    <button class="btn btn-success btn-sm" onclick="addWatch()">確定</button>
                                    <button class="btn btn-sm" onclick="hideAddWatch()">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="watch-list">
                        <div class="empty-state">尚無觀察標的，點擊「+ 新增」開始</div>
                    </div>
                </div>
                <!-- Positions Tab -->
                <div class="tab-pane" id="tab-positions">
                    <div id="positions-container">
                        <div class="empty-state">無持倉</div>
                    </div>
                </div>
                <!-- Orders Tab -->
                <div class="tab-pane" id="tab-orders">
                    <div class="tab-pane-header">
                        <button class="btn btn-sm" onclick="refreshOrders()">🔄 刷新</button>
                    </div>
                    <div id="orders-container">
                        <div class="empty-state">無掛單</div>
                    </div>
                </div>
                <!-- Signals Tab -->
                <div class="tab-pane" id="tab-signals">
                    <div class="tab-pane-header">
                        <button class="btn btn-sm" onclick="clearSignals()">清除</button>
                    </div>
                    <div id="signals-container">
                        <div class="empty-state">尚無信號</div>
                    </div>
                </div>
                <!-- Log Tab -->
                <div class="tab-pane" id="tab-logs">
                    <div class="log-container" id="log-container"></div>
                </div>
            </div>
        </div>

        <!-- Options Panel (appears on signal) -->
        <div class="card full-width" id="options-card" style="display:none;">
            <div class="card-header">
                ⚡ 交易面板
                <button class="btn btn-sm" onclick="closeOptions()">關閉</button>
            </div>
            <div class="card-body" id="options-body">
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Bottom Navigation (mobile only) -->
    <nav class="bottom-nav">
        <button class="bottom-nav-btn active" data-tab="watch" onclick="switchTab('watch')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            <span class="nav-label">觀察</span>
        </button>
        <button class="bottom-nav-btn" data-tab="positions" onclick="switchTab('positions')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            <span class="nav-label">持倉</span>
        </button>
        <button class="bottom-nav-btn" data-tab="orders" onclick="switchTab('orders')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
            <span class="nav-label">掛單</span>
        </button>
        <button class="bottom-nav-btn" data-tab="signals" onclick="switchTab('signals')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span class="nav-label">信號</span>
        </button>
        <button class="bottom-nav-btn" data-tab="logs" onclick="switchTab('logs')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
            <span class="nav-label">日誌</span>
        </button>
    </nav>

    <!-- Bottom Sheet -->
    <div id="bottom-sheet-overlay" class="sheet-overlay" onclick="closeBottomSheet()"></div>
    <div id="bottom-sheet" class="bottom-sheet">
        <div class="sheet-handle" onclick="closeBottomSheet()">
            <div class="sheet-handle-bar"></div>
        </div>
        <div class="sheet-header">
            <span class="sheet-title" id="sheet-title">標題</span>
            <button class="btn btn-sm" id="sheet-refresh-btn" style="display:none;" onclick="refreshSheetContent()">🔄</button>
            <button class="sheet-close" onclick="closeBottomSheet()">✕</button>
        </div>
        <div class="sheet-content" id="sheet-content">
            <!-- Dynamic content goes here -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-box modal-lg">
            <h3>⚙️ 預設配置</h3>
            
            <div class="settings-section">
                <div class="settings-title">📋 交易標的勾選</div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-check-stk"> 標的</label>
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-check-opt1"> 選擇權①</label>
                    <label><input type="checkbox" id="cfg-check-opt2"> 選擇權②</label>
                    <label><input type="checkbox" id="cfg-check-opt3"> 選擇權③</label>
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-check-opt4"> 選擇權④</label>
                    <label><input type="checkbox" id="cfg-check-opt5"> 選擇權⑤</label>
                </div>
                <div class="settings-hint">（選擇權按價格由近至遠排序）</div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">💵 交易金額</div>
                <div class="settings-row">
                    <label>選擇權金額 $<input type="number" id="cfg-opt-amount" value="1000" min="100" step="100" class="settings-input"></label>
                    <label>期貨口數 <input type="number" id="cfg-fut-qty" value="1" min="1" step="1" class="settings-input"></label>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">📤 平倉策略</div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-exit-profit"> 限價止盈</label>
                    <select id="cfg-exit-profit-dir"><option value="+">+</option><option value="-">-</option></select>
                    <input type="number" id="cfg-exit-profit-pts" value="0.5" step="0.1" min="0" class="settings-input-sm">
                    <select id="cfg-exit-profit-unit"><option value="pts">點</option><option value="pct">%</option></select>
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-exit-time"> 時間平倉</label>
                    <input type="time" id="cfg-exit-time-val" value="15:55" class="settings-input">
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-exit-ma"> 均線平倉</label>
                    <select id="cfg-exit-ma-cond"><option value="above">高於</option><option value="below">低於</option></select>
                    MA <select id="cfg-exit-ma-dir"><option value="+">+</option><option value="-">-</option></select>
                    <input type="number" id="cfg-exit-ma-pts" value="5" step="1" min="0" class="settings-input-sm"> 點
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-exit-bb"> BB平倉</label>
                    <select id="cfg-exit-bb-cond"><option value="above">高於</option><option value="below">低於</option></select>
                    <select id="cfg-exit-bb-target"><option value="middle">中軌</option><option value="opposite">反向軌</option></select>
                    <select id="cfg-exit-bb-dir"><option value="+">+</option><option value="-">-</option></select>
                    <input type="number" id="cfg-exit-bb-pts" value="0" step="0.5" min="0" class="settings-input-sm"> 點
                </div>
                <div class="settings-row">
                    <label><input type="checkbox" id="cfg-exit-loop" checked> 閉環（平倉後繼續監控）</label>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-title">▶️ Watch 狀態</div>
                <div class="settings-row">
                    <label><input type="radio" name="cfg-watch-state" value="enabled" checked> 新增時啟用</label>
                    <label><input type="radio" name="cfg-watch-state" value="paused"> 新增時暫停</label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeSettings()">取消</button>
                <button class="btn btn-primary" onclick="applySettingsToAll()">套用至現有清單</button>
                <button class="btn btn-success" onclick="saveSettings()">儲存為預設</button>
            </div>
        </div>
    </div>

    <!-- Close Position Modal -->
    <div id="close-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>📤 平倉</h3>
            <div class="modal-name" id="close-modal-name"></div>
            <div class="modal-row">
                <label>數量</label>
                <div class="modal-input-group">
                    <input type="number" id="close-modal-qty" min="1" max="100">
                    <span class="modal-hint">/ <span id="close-modal-max"></span></span>
                </div>
            </div>
            <div class="modal-row">
                <label>委託類型</label>
                <select id="close-modal-type" onchange="onCloseTypeChange()">
                    <option value="MKT">市價 (MKT)</option>
                    <option value="LMT">限價 (LMT)</option>
                </select>
            </div>
            <div class="modal-row" id="close-modal-limit-row" style="display:none;">
                <label>限價</label>
                <input type="number" id="close-modal-limit-price" step="0.01" min="0.01" placeholder="$">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="hideCloseModal()">取消</button>
                <button class="btn btn-danger" onclick="submitCloseOrder()">確認平倉</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js?v=81"></script>
</body>
</html>
