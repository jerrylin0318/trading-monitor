<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1117">
    <title>Trading Monitor</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>🔐 登入</h2>
            <form id="login-form" onsubmit="return handleLogin(event)">
                <div class="login-field">
                    <label for="login-username">帳號</label>
                    <input type="text" id="login-username" autocomplete="username" required>
                </div>
                <div class="login-field">
                    <label for="login-password">密碼</label>
                    <input type="password" id="login-password" autocomplete="current-password" required>
                </div>
                <div class="login-options">
                    <label><input type="checkbox" id="login-remember-user"> 記住帳號</label>
                    <label><input type="checkbox" id="login-remember-pass"> 記住密碼</label>
                    <label><input type="checkbox" id="login-auto"> 自動登入</label>
                </div>
                <div id="login-error" class="login-error"></div>
                <button type="submit" class="btn btn-success login-btn">登入</button>
            </form>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>📊 Trading Monitor</h1>
        <div class="header-right">
            <div class="controls">
                <span id="ib-status">
                    <span class="status-dot disconnected" id="ib-dot"></span>
                    <span id="ib-label" style="font-size:13px;color:var(--text-secondary)">IB 未連線</span>
                </span>
                <button class="btn btn-sm" id="btn-connect" onclick="toggleConnect()">連線</button>
                <span style="color:var(--border)">|</span>
                <span class="status-dot" id="monitor-dot"></span>
                <span id="monitor-label" style="font-size:13px;color:var(--text-secondary)">未啟動</span>
                <button class="btn btn-sm btn-success" id="btn-monitor" onclick="toggleMonitor()">啟動監控</button>
                <span style="color:var(--border)">|</span>
                <button class="btn btn-sm" onclick="logout()" title="登出">🚪</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Account Info -->
        <div class="card">
            <div class="card-header">💰 帳戶資訊</div>
            <div class="card-body">
                <div class="account-grid" id="account-grid">
                    <div class="account-item">
                        <div class="label">淨值</div>
                        <div class="value" id="acc-equity">--</div>
                    </div>
                    <div class="account-item">
                        <div class="label">可用資金</div>
                        <div class="value" id="acc-available">--</div>
                    </div>
                    <div class="account-item">
                        <div class="label">購買力</div>
                        <div class="value" id="acc-buying-power">--</div>
                    </div>
                    <div class="account-item">
                        <div class="label">未實現盈虧</div>
                        <div class="value" id="acc-unrealized-pnl">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions -->
        <div class="card">
            <div class="card-header">📋 持倉部位</div>
            <div class="card-body">
                <div id="positions-container">
                    <div class="empty-state">無持倉</div>
                </div>
            </div>
        </div>

        <!-- Watch List -->
        <div class="card">
            <div class="card-header">
                👁️ 觀察清單
                <button class="btn btn-sm btn-primary" onclick="showAddWatch()">+ 新增</button>
            </div>
            <div class="card-body">
                <!-- Favorites bar -->
                <div id="favorites-bar" style="display:none; margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;" id="fav-chips"></div>
                </div>
                <!-- Add form (hidden by default) -->
                <div id="add-watch-form" style="display:none; margin-bottom:16px;">
                    <!-- Row 1: 標的 + 類型 + 策略方向 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>標的代碼</label>
                            <input type="text" id="w-symbol" placeholder="SPY, MNQ...">
                        </div>
                        <div class="form-group">
                            <label>類型</label>
                            <select id="w-sectype">
                                <option value="STK">股票 (STK)</option>
                                <option value="FUT">期貨 (FUT)</option>
                                <option value="IND">指數 (IND)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>方向</label>
                            <select id="w-direction">
                                <option value="LONG">📈 做多</option>
                                <option value="SHORT">📉 做空</option>
                            </select>
                        </div>
                    </div>
                    <!-- Row 2: 交易所 + 合約月份 + 幣別 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>交易所</label>
                            <input type="text" id="w-exchange" value="SMART">
                        </div>
                        <div class="form-group" id="w-contract-group" style="display:none;">
                            <label>合約月份</label>
                            <select id="w-contract"></select>
                        </div>
                        <div class="form-group">
                            <label>幣別</label>
                            <input type="text" id="w-currency" value="USD">
                        </div>
                    </div>
                    <!-- Row 3: MA + N點 + 按鈕 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>MA 週期</label>
                            <input type="number" id="w-ma-period" value="21" min="2">
                        </div>
                        <div class="form-group">
                            <label>N 點</label>
                            <input type="number" id="w-n-points" value="5" step="0.1" min="0">
                        </div>
                        <div class="form-group" style="flex:0;">
                            <label style="display:flex;align-items:center;gap:4px;">
                                <input type="checkbox" id="w-confirm-ma-enabled"> 確認MA
                            </label>
                            <input type="number" id="w-confirm-ma-period" value="55" min="2" style="width:60px;" placeholder="週期">
                        </div>
                        <div class="form-group" style="flex:0;">
                            <label>&nbsp;</label>
                            <div style="display:flex;gap:6px;">
                                <button class="btn btn-success btn-sm" onclick="addWatch()">確定</button>
                                <button class="btn btn-sm" onclick="hideAddWatch()">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="watch-list">
                    <div class="empty-state">尚無觀察標的，點擊「+ 新增」開始</div>
                </div>
            </div>
        </div>

        <!-- Signals -->
        <div class="card">
            <div class="card-header">
                🔔 信號記錄
                <button class="btn btn-sm" onclick="clearSignals()">清除</button>
            </div>
            <div class="card-body">
                <div id="signals-container">
                    <div class="empty-state">尚無信號</div>
                </div>
            </div>
        </div>

        <!-- Options Panel (appears on signal) -->
        <div class="card full-width" id="options-card" style="display:none;">
            <div class="card-header">
                ⚡ 選擇權交易面板
                <button class="btn btn-sm" onclick="closeOptions()">關閉</button>
            </div>
            <div class="card-body" id="options-body">
            </div>
        </div>

        <!-- Log -->
        <div class="card full-width">
            <div class="card-header">📜 日誌</div>
            <div class="card-body">
                <div class="log-container" id="log-container"></div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/static/app.js"></script>
</body>
</html>
